using DelimitedFiles
using Test
using ItuRPropagation

struct TestData
    testinput
    answer
end

println("\n<===== " * "ITUR P838.3 "^5 * " =====")



errors = []
@testset "iturP838 (Itu-R P.838-3) test against ITU-R data" begin
    println(" ")
    itudata = [
        TestData((14.25, 31.08, 26.48, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.039754879733, 1.124180428138, 1.581308393669)),
        TestData((14.25, 40.23, 33.94, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040076240755, 1.118041377479, 2.061732131264)),
        TestData((14.25, 46.36, 27.14, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040303441706, 1.113760168049, 1.592084199306)),
        TestData((14.25, 31.08, 26.48, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.039754879733, 1.124180428138, 1.581308393669)),
        TestData((14.25, 40.23, 33.94, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040076240755, 1.118041377479, 2.061732131264)),
        TestData((14.25, 46.36, 27.14, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040303441706, 1.113760168049, 1.592084199306)),
        TestData((14.25, 31.08, 26.48, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.039754879733, 1.124180428138, 1.581308393669)),
        TestData((14.25, 40.23, 33.94, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040076240755, 1.118041377479, 2.061732131264)),
        TestData((14.25, 46.36, 27.14, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040303441706, 1.113760168049, 1.592084199306)),
        TestData((14.25, 31.08, 26.48, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.039754879733, 1.124180428138, 1.581308393669)),
        TestData((14.25, 40.23, 33.94, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040076240755, 1.118041377479, 2.061732131264)),
        TestData((14.25, 46.36, 27.14, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040303441706, 1.113760168049, 1.592084199306)),
        TestData((29.00, 31.08, 26.48, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.221068036849, 0.953200051046, 5.021801889091)),
        TestData((29.00, 40.23, 33.94, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.220314041405, 0.950444599285, 6.278460239727)),
        TestData((29.00, 46.36, 27.14, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.219780969655, 0.948485097658, 5.031354793621)),
        TestData((29.00, 31.08, 26.48, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.221068036849, 0.953200051046, 5.021801889091)),
        TestData((29.00, 40.23, 33.94, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.220314041405, 0.950444599285, 6.278460239727)),
        TestData((29.00, 46.36, 27.14, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.219780969655, 0.948485097658, 5.031354793621)),
        TestData((29.00, 31.08, 26.48, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.221068036849, 0.953200051046, 5.021801889091)),
        TestData((29.00, 40.23, 33.94, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.220314041405, 0.950444599285, 6.278460239727)),
        TestData((29.00, 46.36, 27.14, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.219780969655, 0.948485097658, 5.031354793621)),
        TestData((29.00, 31.08, 26.48, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.221068036849, 0.953200051046, 5.021801889091)),
        TestData((29.00, 40.23, 33.94, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.220314041405, 0.950444599285, 6.278460239727)),
        TestData((29.00, 46.36, 27.14, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.219780969655, 0.948485097658, 5.031354793621)),
        TestData((14.25, 22.28, 50.64, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.039493190426, 1.129253356762, 3.321396377666)),
        TestData((14.25, 52.68, 78.30, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040535220533, 1.109442149295, 5.115034633106)),
        TestData((14.25, 22.28, 50.64, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.039493190426, 1.129253356762, 3.321396377666)),
        TestData((14.25, 52.68, 78.30, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040535220533, 1.109442149295, 5.115034633106)),
        TestData((14.25, 22.28, 50.64, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.039493190426, 1.129253356762, 3.321396377666)),
        TestData((14.25, 52.68, 78.30, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040535220533, 1.109442149295, 5.115034633106)),
        TestData((14.25, 22.28, 50.64, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.039493190426, 1.129253356762, 3.321396377666)),
        TestData((14.25, 52.68, 78.30, EnumHorizontalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.040535220533, 1.109442149295, 5.115034633106)),
        TestData((29.00, 22.28, 50.64, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.221682027133, 0.955430012122, 9.424302438086)),
        TestData((29.00, 52.68, 78.30, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.219237157034, 0.946476295077, 13.592900863759)),
        TestData((29.00, 22.28, 50.64, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.221682027133, 0.955430012122, 9.424302438086)),
        TestData((29.00, 52.68, 78.30, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.219237157034, 0.946476295077, 13.592900863759)),
        TestData((29.00, 22.28, 50.64, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.221682027133, 0.955430012122, 9.424302438086)),
        TestData((29.00, 52.68, 78.30, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.219237157034, 0.946476295077, 13.592900863759)),
        TestData((29.00, 22.28, 50.64, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.221682027133, 0.955430012122, 9.424302438086)),
        TestData((29.00, 52.68, 78.30, EnumHorizontalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.219237157034, 0.946476295077, 13.592900863759)),
        TestData((14.25, 48.24, 63.63, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.042264735477, 1.078716641993, 3.729012635187)),
        TestData((14.25, 85.80, 99.14, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.041330390679, 1.094996287542, 6.340645980226)),
        TestData((14.25, 20.14, 42.91, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.043198351559, 1.063153100323, 2.350323233084)),
        TestData((14.25, 48.24, 63.63, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.042264735477, 1.078716641993, 3.729012635187)),
        TestData((14.25, 85.80, 99.14, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.041330390679, 1.094996287542, 6.340645980226)),
        TestData((14.25, 20.14, 42.91, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.043198351559, 1.063153100323, 2.350323233084)),
        TestData((14.25, 48.24, 63.63, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.042264735477, 1.078716641993, 3.729012635187)),
        TestData((14.25, 85.80, 99.14, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.041330390679, 1.094996287542, 6.340645980226)),
        TestData((14.25, 20.14, 42.91, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.043198351559, 1.063153100323, 2.350323233084)),
        TestData((14.25, 48.24, 63.63, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.042264735477, 1.078716641993, 3.729012635187)),
        TestData((14.25, 85.80, 99.14, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.041330390679, 1.094996287542, 6.340645980226)),
        TestData((14.25, 20.14, 42.91, EnumVerticalPolarization), ( 0.039186742018, 0.043451215355, 1.135280082536, 1.059052919700, 0.043198351559, 1.063153100323, 2.350323233084)),
        TestData((29.00, 48.24, 63.63, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.215179271044, 0.931166214727, 10.286991626085)),
        TestData((29.00, 85.80, 99.14, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.217371483768, 0.939508247945, 16.318368602161)),
        TestData((29.00, 20.14, 42.91, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.212988768075, 0.922659165712, 6.833645557217)),
        TestData((29.00, 48.24, 63.63, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.215179271044, 0.931166214727, 10.286991626085)),
        TestData((29.00, 85.80, 99.14, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.217371483768, 0.939508247945, 16.318368602161)),
        TestData((29.00, 20.14, 42.91, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.212988768075, 0.922659165712, 6.833645557217)),
        TestData((29.00, 48.24, 63.63, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.215179271044, 0.931166214727, 10.286991626085)),
        TestData((29.00, 85.80, 99.14, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.217371483768, 0.939508247945, 16.318368602161)),
        TestData((29.00, 20.14, 42.91, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.212988768075, 0.922659165712, 6.833645557217)),
        TestData((29.00, 48.24, 63.63, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.215179271044, 0.931166214727, 10.286991626085)),
        TestData((29.00, 85.80, 99.14, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.217371483768, 0.939508247945, 16.318368602161)),
        TestData((29.00, 20.14, 42.91, EnumVerticalPolarization), ( 0.222401033757, 0.212395484704, 0.958025732031, 0.920324888574, 0.212988768075, 0.922659165712, 6.833645557217)),
    ]
    allowableerror = 1.0e-3
    for testdata in itudata
        value = ItuRP838.rainspecificattenuation(testdata.testinput...)
        error = abs(value - testdata.answer[7])
        @test error < allowableerror
        push!(errors, error)
    end
end
println("MAX ERROR: $(maximum(errors)) dB\n")



println("===== " * "ITUR P838.3 "^5 * "=====> \n")
